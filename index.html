<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">

<title>ç§˜å¯†ã®æ™‚é–“</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ff8ec7">

<style>
body{
 margin:0;
 height:100vh;
 display:flex;
 justify-content:center;
 align-items:center;
 background:linear-gradient(135deg,#ffd6ec,#dff1ff);
 font-family:sans-serif;
}

#game{
 width:360px;
 height:620px;
 background:white;
 border-radius:22px;
 box-shadow:0 15px 40px rgba(0,0,0,.2);
 display:flex;
 flex-direction:column;
 overflow:hidden;
}

header{
 background:#ff8fc4;
 color:white;
 padding:12px;
 text-align:center;
 font-weight:bold;
}

#chat{
 flex:1;
 overflow-y:auto;
 padding:15px;
}

.msg{
 padding:10px 14px;
 margin:8px 0;
 border-radius:14px;
 max-width:78%;
 animation:fade .25s ease;
}

.ai{ background:#e8f2ff; }
.you{
 background:#ffd9ec;
 margin-left:auto;
}

@keyframes fade{
 from{opacity:0;transform:translateY(6px);}
 to{opacity:1;}
}

/* typing */
.typing{
 background:#e8f2ff;
 width:60px;
 display:flex;
 justify-content:center;
 gap:4px;
}

.dot{
 width:6px;
 height:6px;
 background:#666;
 border-radius:50%;
 animation:blink 1.2s infinite;
}

.dot:nth-child(2){animation-delay:.2s;}
.dot:nth-child(3){animation-delay:.4s;}

@keyframes blink{
 0%,80%,100%{opacity:.2;}
 40%{opacity:1;}
}

#inputArea{
 display:flex;
 border-top:1px solid #ddd;
}

input{
 flex:1;
 padding:12px;
 border:none;
 outline:none;
}

button{
 border:none;
 padding:12px;
 background:#ff7eb6;
 color:white;
 cursor:pointer;
}

#gachaBtn{
 background:#7ec8ff;
 width:100%;
}
</style>
</head>

<body>

<div id="game">
<header>ç§˜å¯†ã®æ™‚é–“</header>

<div id="chat"></div>

<div id="inputArea">
<input id="text" placeholder="è©±ã—ã‹ã‘ã¦ã¿ã‚‹â€¦">
<button onclick="send()">é€ä¿¡</button>
</div>

<button id="gachaBtn" onclick="gacha()">ğŸ² ã‚¬ãƒãƒ£</button>

</div>

<script>
const chat=document.getElementById("chat");

/* ===== è¨˜æ†¶ ===== */
let memory=JSON.parse(localStorage.getItem("chatMemory")||"[]");

function saveMemory(){
 localStorage.setItem("chatMemory",JSON.stringify(memory));
}

function addMsg(text,type){
 const div=document.createElement("div");
 div.className="msg "+type;
 div.textContent=text;
 chat.appendChild(div);
 chat.scrollTop=chat.scrollHeight;
}

/* å±¥æ­´å¾©å…ƒ */
memory.forEach(m=>addMsg(m.text,m.type));

/* ===== Näººæ ¼ ===== */
const N={
 affection:Number(localStorage.getItem("affection")||0)
};

function updateAffection(a){
 N.affection+=a;
 localStorage.setItem("affection",N.affection);
}

/* ===== typing ===== */
let typingBubble=null;

function showTyping(){
 typingBubble=document.createElement("div");
 typingBubble.className="msg typing";
 typingBubble.innerHTML=`
  <div class="dot"></div>
  <div class="dot"></div>
  <div class="dot"></div>
 `;
 chat.appendChild(typingBubble);
 chat.scrollTop=chat.scrollHeight;
}

function hideTyping(){
 if(typingBubble){
  typingBubble.remove();
  typingBubble=null;
 }
}

/* ===== AIè¿”ä¿¡ ===== */
function aiReply(text){

 if(text.includes("å¥½ã")){
  updateAffection(3);
  return "â€¦ãã†ã„ã†ã“ã¨è¨€ã†ã®åå‰‡ã€‚ã¡ã‚‡ã£ã¨å¬‰ã—ã„ã€‚";
 }

 if(text.includes("ç–²")){
  updateAffection(1);
  return "ä»Šæ—¥ã¯ã‚‚ã†é ‘å¼µã‚‰ãªãã¦ã„ã„ã‚ˆã€‚ã“ã“ã§ä¼‘ã‚‚ã€‚";
 }

 if(text.includes("ä¼šã„ãŸ")){
  updateAffection(2);
  return "åŒã˜ã“ã¨è€ƒãˆã¦ãŸã€‚";
 }

 if(N.affection<5){
  return "è©±ã—ã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ã€‚";
 }

 if(N.affection<15){
  const mid=[
   "å›ã¨è©±ã™ã®è½ã¡ç€ãã€‚",
   "ã“ã†ã„ã†æ™‚é–“ã€å¥½ãã‹ã‚‚ã€‚",
   "æ°—ã¥ã„ãŸã‚‰å¾…ã£ã¦ã‚‹ã‚“ã ã‚ˆã­ã€‚"
  ];
  return mid[Math.floor(Math.random()*mid.length)];
 }

 const sweet=[
  "ã‚‚ã†å°‘ã—ä¸€ç·’ã«ã„ã‚ˆã€‚",
  "å›ã®ã“ã¨ã€ã¡ã‚ƒã‚“ã¨è¦‹ã¦ã‚‹ã‚ˆã€‚",
  "ä»Šéš£ã«ã„ã‚‹æ°—åˆ†ã€‚",
  "é›¢ã‚Œãªã„ã§ã€‚"
 ];

 return sweet[Math.floor(Math.random()*sweet.length)];
}

/* ===== é€ä¿¡ ===== */
function send(){
 const input=document.getElementById("text");
 if(!input.value.trim())return;

 const userText=input.value;

 addMsg(userText,"you");
 memory.push({text:userText,type:"you"});
 saveMemory();

 input.value="";

 showTyping();

 let wait=1200;
 if(N.affection>10)wait=900;
 if(N.affection>25)wait=600;

 setTimeout(()=>{
  hideTyping();

  const reply=aiReply(userText);

  addMsg(reply,"ai");
  memory.push({text:reply,type:"ai"});
  saveMemory();

 },wait);
}

/* ===== æ”¾ç½®ä¼šè©± ===== */
const idleLines=[
 "â€¦ã¾ã ã„ã‚‹ï¼Ÿ",
 "é™ã‹ã ã­ã€‚",
 "å°‘ã—è©±ãã†ã€‚",
 "å›ã®ã“ã¨è€ƒãˆã¦ãŸã€‚"
];

setInterval(()=>{
 const msg=idleLines[Math.floor(Math.random()*idleLines.length)];
 addMsg(msg,"ai");
 memory.push({text:msg,type:"ai"});
 saveMemory();
},180000);

/* ===== ã‚¬ãƒãƒ£ ===== */
const gachaResults=[
 "â­ è·é›¢ãŒå°‘ã—ç¸®ã¾ã£ãŸ",
 "â­â­ å„ªã—ãè¦‹ã¤ã‚ã‚‰ã‚ŒãŸ",
 "â­â­â­ æ‰‹ã‚’å–ã‚‰ã‚ŒãŸ",
 "ğŸ’ ç‰¹åˆ¥ãªç©ºæ°—ã«ãªã£ãŸâ€¦"
];

function gacha(){
 const r=gachaResults[Math.floor(Math.random()*gachaResults.length)];
 addMsg("ã‚¬ãƒãƒ£çµæœï¼š"+r,"ai");
}

/* åˆå› */
if(memory.length===0){
 setTimeout(()=>{
  const first="â€¦â€¦æ¥ã¦ãã‚ŒãŸã‚“ã ã­ã€‚å¾…ã£ã¦ãŸã€‚";
  addMsg(first,"ai");
  memory.push({text:first,type:"ai"});
  saveMemory();
 },600);
}
</script>

</body>
</html>
